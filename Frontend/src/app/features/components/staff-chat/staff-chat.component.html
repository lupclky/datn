<div class="staff-chat-container">
  <div class="chat-header">
    <h2><i class="pi pi-comments"></i> Chat với khách hàng</h2>
  </div>

  <div class="chat-layout">
    <!-- Customers List -->
    <div class="customers-sidebar">
      <div class="sidebar-header">
        <h3>Danh sách khách hàng</h3>
      </div>
      <div class="customers-list">
        @if(customers.length === 0 && !isLoading) {
          <div class="empty-state">
            <p>Chưa có tin nhắn từ khách hàng</p>
          </div>
        }
        @for(customer of customers; track customer.userId) {
          <div 
            class="customer-item" 
            [class.active]="selectedCustomerId === customer.userId"
            (click)="selectCustomer(customer.userId, customer.userName)">
            <div class="customer-info">
              <strong>{{ customer.userName }}</strong>
              <p class="last-message">{{ customer.lastMessage }}</p>
            </div>
            @if(customer.unreadCount > 0) {
              <span class="unread-badge">{{ customer.unreadCount }}</span>
            }
          </div>
        }
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-main">
      @if(!selectedCustomerId) {
        <div class="no-selection">
          <i class="pi pi-comments" style="font-size: 4rem; color: #ccc;"></i>
          <p>Chọn khách hàng để bắt đầu trò chuyện</p>
        </div>
      } @else {
        <div class="chat-header-bar">
          <h3>{{ selectedCustomerName }}</h3>
          <button 
            pButton 
            icon="pi pi-times-circle" 
            label="Kết thúc cuộc trò chuyện"
            (click)="closeConversation()"
            class="close-conversation-btn"
            [pTooltip]="'Đóng cuộc trò chuyện này'">
          </button>
        </div>
        
        <div class="messages-container" #scrollContainer>
          @if(messages.length === 0) {
            <div class="empty-messages">
              <p>Chưa có tin nhắn nào</p>
            </div>
          }
          @for(message of messages; track message.id) {
            <div class="message" [class.staff]="message.isStaffMessage" [class.customer]="!message.isStaffMessage">
              <div class="message-bubble">
                @if(message.messageType === 'IMAGE' && message.fileUrl) {
                  <img [src]="getFileUrl(message.fileUrl)" alt="Image" class="message-image" (click)="openImagePreview(getFileUrl(message.fileUrl))">
                  @if(message.message) {
                    <p>{{ message.message }}</p>
                  }
                } @else if(message.messageType === 'FILE' && message.fileUrl) {
                  <div class="file-attachment">
                    <i class="pi pi-file"></i>
                    <a [href]="getFileUrl(message.fileUrl)" target="_blank" download>{{ message.fileName || message.message || 'Download file' }}</a>
                  </div>
                } @else {
                  <p>{{ message.message }}</p>
                }
                <span class="message-time">{{ message.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </div>
          }
          @if(isLoading) {
            <div class="loading-indicator">
              <i class="pi pi-spin pi-spinner"></i>
            </div>
          }
        </div>

        @if(isConversationClosed) {
          <div class="conversation-closed-banner">
            <i class="pi pi-info-circle"></i>
            <span>Cuộc trò chuyện này đã được đóng. Khách hàng không thể gửi tin nhắn mới.</span>
          </div>
        }
        
        <div class="chat-input-area" [class.disabled]="isConversationClosed">
          @if(filePreview) {
            <div class="file-preview">
              <img [src]="filePreview" alt="Preview" *ngIf="selectedFile && selectedFile.type.startsWith('image/')">
              <div class="file-info" *ngIf="selectedFile && !selectedFile.type.startsWith('image/')">
                <i class="pi pi-file"></i>
                <span>{{ selectedFile.name }}</span>
              </div>
              <button type="button" class="remove-file-btn" (click)="removeFile()">
                <i class="pi pi-times"></i>
              </button>
            </div>
          }
          <div class="input-row">
            <input 
              type="file" 
              #fileInput
              (change)="onFileSelected($event)"
              style="display: none;"
              accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar">
            <button 
              type="button"
              pButton 
              icon="pi pi-paperclip" 
              (click)="fileInput.click()"
              class="attach-button"
              [pTooltip]="'Đính kèm file'">
            </button>
            <input 
              type="text" 
              [(ngModel)]="newMessage"
              (keyup.enter)="sendMessage()"
              placeholder="Nhập tin nhắn..."
              class="message-input">
            <button 
              pButton 
              icon="pi pi-send" 
              (click)="sendMessage()"
              [disabled]="(!newMessage.trim() && !selectedFile) || isConversationClosed"
              class="send-button">
            </button>
          </div>
        </div>
      }
    </div>
  </div>
</div>

